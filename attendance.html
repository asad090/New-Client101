<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Master Attendance Intelligence | Final Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9; --bg: #f3f4f6;
        }

        body { background-color: var(--bg); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s; }
        body.report-finalized { background-color: #cbd5e0; }

        /* LAYER HIERARCHY */
        header { background: #1e1b4b; color: white; padding: 0.8rem 2rem; position: relative; z-index: 100; flex-shrink: 0; }
        .filter-tool-bar { background: #ffffff; padding: 12px 30px; border-bottom: 2px solid var(--primary); position: relative; z-index: 200; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .control-bar { background: #fff; padding: 10px 30px; border-bottom: 1px solid #e2e8f0; position: relative; z-index: 150; }
        .date-context-bar { background: #eef2ff; padding: 6px 30px; border-bottom: 1px solid #e0e7ff; color: var(--primary); font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; position: relative; z-index: 140; }

        .dashboard-main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 15px; flex-grow: 1; overflow: hidden; position: relative; z-index: 10; }

        .attendance-panel { background: #fff; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .panel-title { padding: 12px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-weight: 700; background: #fafafa; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 12px; }

        /* STUDENT CARDS */
        .student-card { 
            background: #fff; border: 1px solid #f1f5f9; border-radius: 10px; padding: 10px 15px; 
            margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; 
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .student-card:hover { border-color: var(--primary); background: #fbfbff; }
        .student-card.highlight-filter { border: 2px solid var(--warning); background: #fffbeb; }

        .info-block b { display: block; font-size: 0.95rem; color: #1e293b; line-height: 1.2; }
        .info-block span { font-size: 0.75rem; color: #64748b; font-weight: 600; }

        /* HOVER POPOVER - FORCED TOP LAYER */
        .history-popover {
            visibility: hidden; opacity: 0; width: 240px; background: #1e1b4b; color: #fff;
            border-radius: 8px; padding: 12px; position: absolute; 
            z-index: 9999 !important; 
            left: 50%; top: 90%; transform: translateX(-50%); 
            transition: 0.2s; font-size: 0.75rem; pointer-events: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .student-card:hover .history-popover { visibility: visible; opacity: 1; }

        /* STATE MANAGEMENT */
        .report-finalized .btn-move, .report-finalized .filter-tool-bar, .report-finalized .dropdown, .report-finalized select { display: none !important; }
        .report-finalized .student-card { cursor: pointer; }

        .btn-move { width: 30px; height: 30px; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .mode-select { border-radius: 8px; border: 1px solid #cbd5e1; padding: 4px 10px; font-size: 0.8rem; font-weight: 600; }
        .category-label { font-size: 0.65rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin: 15px 0 8px 5px; }

        /* MODAL */
        .profile-header { background: var(--primary); color: white; border-radius: 15px 15px 0 0; padding: 25px; }
        .stat-card { background: #f8fafc; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e2e8f0; }
    </style>
</head>
<body id="masterBody">

<header>
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="m-0 fw-bold">Accounting and Business Management</h4>
            <div class="d-flex gap-3 mt-1 opacity-75 small">
                <span>Instructor: <b>Aman Shahi</b></span>
                <span>Batch: <b>Morning-A (250 Enrolled)</b></span>
                <span id="lockStatus" class="badge bg-success d-none">LMS FINALIZED REPORT</span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <input type="date" id="classDate" class="mode-select text-primary" value="2025-12-16" onchange="updateDateContext()">
            <button id="btnFinalize" class="btn btn-success fw-bold px-4" onclick="toggleReport(true)">Finalize Attendance</button>
            <button id="btnEdit" class="btn btn-warning fw-bold px-4 d-none" onclick="toggleReport(false)">Edit Report</button>
        </div>
    </div>
</header>

<div class="filter-tool-bar" id="smartFilter">
    <div class="d-flex align-items-center gap-2"><i data-lucide="zap" class="text-warning" size="18"></i> <span class="fw-bold small">SMART FILTER:</span></div>
    <div class="input-group" style="width: 250px;">
        <span class="input-group-text bg-light border-end-0 small">Min Duration:</span>
        <input type="number" id="minTimeInput" class="form-control" value="30">
    </div>
    <button class="btn btn-primary btn-sm fw-bold" onclick="runSmartFilter()">Identify Students</button>
    <div id="bulkActions" class="ms-3 d-none">
        <button class="btn btn-danger btn-sm fw-bold" onclick="bulkMove('absent')">Move Selected to Absent</button>
        <button class="btn btn-link btn-sm text-secondary" onclick="clearFilters()">Clear</button>
    </div>
</div>

<div class="date-context-bar">
    <i data-lucide="calendar-days" size="14"></i> VIEWING DATA FOR: <span id="fullDateDisplay">Tuesday, December 16, 2025</span>
</div>

<div class="control-bar d-flex align-items-center gap-3">
    <div class="input-group" style="max-width: 300px;">
        <span class="input-group-text bg-transparent border-end-0"><i data-lucide="search" size="16"></i></span>
        <input type="text" id="mainSearch" class="form-control border-start-0" placeholder="Search by name or ID..." oninput="render()">
    </div>
    <div class="vr mx-2"></div>
    <div class="d-flex align-items-center gap-2">
        <label class="small fw-bold text-muted">Mode:</label>
        <select id="sessionType" class="mode-select" onchange="render()">
            <option value="online">Online (BBB)</option>
            <option value="in-person">In-Person</option>
        </select>
    </div>
    <div class="ms-auto d-flex gap-4 text-muted small">
        <span class="text-success"><b>Present:</b> <span id="pCountVal">0</span></span>
        <span class="text-danger"><b>Absent:</b> <span id="aCountVal">0</span></span>
    </div>
</div>

<div class="dashboard-main">
    <div class="attendance-panel">
        <div class="panel-title"><span><i data-lucide="user-check" class="text-success me-2"></i> PRESENT</span><span id="p-count" class="badge bg-primary rounded-pill">0</span></div>
        <div id="p-list" class="scroll-area"></div>
    </div>
    <div class="attendance-panel">
        <div class="panel-title" style="background: #fffafa;"><span><i data-lucide="user-minus" class="text-danger me-2"></i> ABSENT & LEAVE</span><span id="a-count" class="badge bg-danger rounded-pill">0</span></div>
        <div id="a-list" class="scroll-area" style="background: #fafafa;"></div>
    </div>
</div>

<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 shadow-lg" style="border-radius: 15px;"><div id="modalBody"></div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 50 STUDENTS DATASET
    let enrollment = [];
    for(let i=1; i<=50; i++) {
        enrollment.push({
            id: 'ID-440'+i,
            name: ['Arjun Mehta','Zoe Robinson','Kevin Lee','Sarah Johnson','Mike Tyson','Robert Brown','Emma Watson','Liam Neeson','Noah Miller','Sophia Taylor'][i%10] + ' ' + i,
            leave: i % 15 === 0,
            lType: 'Medical',
            attPct: Math.floor(Math.random() * 30) + 70,
            totalClasses: 45,
            totalLeaves: Math.floor(Math.random() * 5)
        });
    }

    // MULTI-ATTEMPT LOGS
    let sessionLogs = [];
    for(let i=1; i<=35; i++) {
        let attempts = (i % 4 === 0) ? 3 : 1;
        let details = [];
        for(let a=0; a<attempts; a++) details.push({j: '09:'+(a*12), l: '09:'+(a*12+10), d: (i%2==0 ? 12 : 25)});
        sessionLogs.push({ sid: 'ID-440'+i, h: details });
    }

    let filteredSids = new Set();
    let isReportFinalized = false;

    function render() {
        const query = document.getElementById('mainSearch').value.toLowerCase();
        const mode = document.getElementById('sessionType').value;
        const pList = document.getElementById('p-list');
        const aList = document.getElementById('a-list');
        pList.innerHTML = ''; aList.innerHTML = '';

        const activeMap = {};
        if (mode === 'online') {
            sessionLogs.forEach(l => {
                const total = l.h.reduce((s, x) => s + x.d, 0);
                activeMap[l.sid] = { total, count: l.h.length, history: l.h };
            });
        }

        enrollment.forEach(s => {
            if (query && !s.name.toLowerCase().includes(query) && !s.id.toLowerCase().includes(query)) return;
            const logEntry = activeMap[s.id];
            const isF = filteredSids.has(s.id);

            if(logEntry || (mode === 'in-person' && s.manualPresent)) {
                const totalMins = logEntry ? logEntry.total : 60;
                const pct = Math.round((totalMins/60)*100);
                
                pList.innerHTML += `
                <div class="student-card ${isF ? 'highlight-filter' : ''}" onclick="openProfile('${s.id}')">
                    ${logEntry ? `<div class="history-popover"><b>Online Session History:</b><br>${logEntry.history.map(d=>`• ${d.j} - ${d.l} (${d.d}m)`).join('<br>')}</div>` : ''}
                    <div class="info-block"><b>${s.name}</b><span>ID: ${s.id}</span></div>
                    <div class="d-flex align-items-center gap-3">
                        ${logEntry ? `<span class="badge bg-light text-dark border small">${logEntry.count} Joins</span>` : '<span class="badge bg-success-subtle text-success small">In-Person</span>'}
                        <div class="text-end" style="min-width:50px"><b class="${pct < 50 ? 'text-danger' : 'text-success'}">${totalMins}m</b><div class="small text-muted">${pct}%</div></div>
                        <button class="btn btn-sm btn-move" onclick="event.stopPropagation(); swap('${s.id}')"><i data-lucide="x" size="14"></i></button>
                    </div>
                </div>`;
            } else {
                const tag = s.leave ? 'AUTHORIZED' : 'UNEXCUSED';
                if(!aList.innerHTML.includes(tag)) aList.innerHTML += `<div class="category-label ${s.leave ? 'text-info' : ''}">${tag} ABSENTEES</div>`;
                aList.innerHTML += `
                <div class="student-card" onclick="openProfile('${s.id}')">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-sm btn-move" style="color:var(--success)" onclick="event.stopPropagation(); swap('${s.id}')"><i data-lucide="plus" size="14"></i></button>
                        <div class="info-block"><b>${s.name}</b><span>ID: ${s.id}</span></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        ${s.leave ? `<span class="badge bg-info-subtle text-info rounded-pill px-3 small">${s.lType}</span>` : `
                            <div class="dropdown" onclick="event.stopPropagation()">
                                <button class="btn btn-light btn-sm dropdown-toggle border" style="font-size:0.7rem" data-bs-toggle="dropdown">Mark Leave</button>
                                <ul class="dropdown-menu shadow">
                                    <li><a class="dropdown-item small" href="#">Mark Sick</a></li>
                                    <li><a class="dropdown-item small" href="#">Authorized</a></li>
                                    <li><a class="dropdown-item small" href="#">Tech Issue</a></li>
                                </ul>
                            </div>
                            <span class="badge bg-danger-subtle text-danger rounded-pill px-3 small">ABSENT</span>
                        `}
                    </div>
                </div>`;
            }
        });
        const pNum = document.querySelectorAll('#p-list .student-card').length;
        document.getElementById('p-count').innerText = pNum;
        document.getElementById('pCountVal').innerText = pNum;
        document.getElementById('a-count').innerText = enrollment.length - pNum;
        document.getElementById('aCountVal').innerText = enrollment.length - pNum;
        lucide.createIcons();
    }

    function toggleReport(finalize) {
        isReportFinalized = finalize;
        document.getElementById('masterBody').className = finalize ? 'report-finalized' : '';
        document.getElementById('btnFinalize').classList.toggle('d-none', finalize);
        document.getElementById('btnEdit').classList.toggle('d-none', !finalize);
        document.getElementById('lockStatus').classList.toggle('d-none', !finalize);
        render();
    }

    function runSmartFilter() {
        const min = parseInt(document.getElementById('minTimeInput').value);
        filteredSids.clear();
        sessionLogs.forEach(l => { if(l.h.reduce((s,x)=>s+x.d,0) < min) filteredSids.add(l.sid); });
        document.getElementById('bulkActions').classList.toggle('d-none', filteredSids.size === 0);
        render();
    }

    function bulkMove(type) {
        if(type === 'absent') sessionLogs = sessionLogs.filter(l => !filteredSids.has(l.sid));
        filteredSids.clear();
        document.getElementById('bulkActions').classList.add('d-none');
        render();
    }

    function clearFilters() { filteredSids.clear(); document.getElementById('bulkActions').classList.add('d-none'); render(); }

    function openProfile(sid) {
        const s = enrollment.find(x => x.id === sid);
        document.getElementById('modalBody').innerHTML = `
            <div class="profile-header d-flex justify-content-between">
                <div><h3 class="m-0">${s.name}</h3><span>ID: ${s.id} • Semester performance</span></div>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3 mb-4">
                    <div class="col-4"><div class="stat-card"><small class="text-muted">Attendance Rate</small><h2 class="m-0 text-primary">${s.attPct}%</h2></div></div>
                    <div class="col-4"><div class="stat-card"><small class="text-muted">Total Classes</small><h2 class="m-0">${s.totalClasses}</h2></div></div>
                    <div class="col-4"><div class="stat-card"><small class="text-muted">Total Leaves</small><h2 class="m-0 text-danger">${s.totalLeaves}</h2></div></div>
                </div>
                <h6 class="fw-bold mb-3">Recent Class Log History</h6>
                <div class="list-group list-group-flush border-top small">
                    <div class="list-group-item d-flex justify-content-between px-0"><span>Dec 15: Introduction to Finance</span><span class="text-success fw-bold">Present (100%)</span></div>
                    <div class="list-group-item d-flex justify-content-between px-0"><span>Dec 14: Macroeconomics</span><span class="text-danger fw-bold">Absent</span></div>
                    <div class="list-group-item d-flex justify-content-between px-0"><span>Dec 12: Business Ethics</span><span class="text-info fw-bold">Medical Leave</span></div>
                </div>
            </div>`;
        new bootstrap.Modal(document.getElementById('studentModal')).show();
    }

    function swap(sid) {
        const mode = document.getElementById('sessionType').value;
        if(mode === 'online') {
            const idx = sessionLogs.findIndex(l => l.sid === sid);
            if(idx > -1) sessionLogs.splice(idx, 1);
            else sessionLogs.push({ sid: sid, h: [{j: 'Manual', l: '-', d: 60}] });
        } else {
            const s = enrollment.find(x => x.id === sid);
            s.manualPresent = !s.manualPresent;
        }
        render();
    }

    function updateDateContext() {
        const d = new Date(document.getElementById('classDate').value);
        document.getElementById('displayDateHeader').innerText = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        document.getElementById('fullDateDisplay').innerText = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        render();
    }

    render();
</script>
</body>
</html>